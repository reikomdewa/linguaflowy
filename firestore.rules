rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 0. HELPER FUNCTIONS ---
    function isAdmin() {
      return request.auth.token.email in [
        "reikomuk@gmail.com",
        "reikomlive@gmail.com"
      ];
    }

    // --- 1. PROMO CODES ---
    match /promo_codes/{code} {
      allow read: if request.auth != null;
      allow create, delete: if isAdmin();
      allow update: if request.auth != null; 
    }

    // --- 2. USERS COLLECTION (Updated) ---
    match /users/{userId} {
      // 1. Allow ANY logged-in user to READ user profiles (Required for Leaderboard)
      allow read: if request.auth != null;
      
      // 2. Only allow the user themselves OR an Admin to EDIT the profile data
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // 3. *** NEW FIX *** 
      // Allow the user to read/write their own sub-collections (limits, vocabulary, saved_words)
      // The recursive wildcard {document=**} covers 'limits/dictionary', 'vocabulary/xxx', etc.
      match /{document=**} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // --- 3. LESSONS COLLECTION (Updated for Admin CMS) ---
    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      
      // Allow Admins to do ANYTHING. 
      // Allow regular users to create only if they own it.
      allow write: if isAdmin() || (request.auth != null && request.resource.data.userId == request.auth.uid);
    }

    // --- 4. VOCABULARY COLLECTION ---
    match /{path=**}/vocabulary_items/{itemId} {
      allow read, write: if request.auth != null;
    }
    
    match /vocabulary/{vocabId} {
      allow read, write: if request.auth != null;
    }

    // --- 5. BUG REPORTS ---
    match /bug_reports/{reportId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }
    
    // --- 6. ADMIN NOTIFICATIONS QUEUE ---
    match /admin_notifications_queue/{notifId} {
       allow read, write: if isAdmin();
    }
  }
}